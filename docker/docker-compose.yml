# Docker Compose Configuration for E-commerce Microservices Platform
# This file defines all infrastructure services needed for local development

# Docker Compose version
version: '3.8'

# Define all services (containers)
services:
  
  # ==================== DATABASES ====================
  
  # PostgreSQL - Relational database for transactional data
  # Used by: Auth Service, User Service, Order Service, Payment Service
  postgres:
    image: postgres:15-alpine  # Lightweight Alpine Linux version
    container_name: ecommerce-postgres
    environment:
      # Root password for PostgreSQL
      POSTGRES_PASSWORD: postgres
      # Create multiple databases on startup
      POSTGRES_MULTIPLE_DATABASES: auth_db,user_db,order_db,payment_db
    ports:
      # Map container port 5432 to host port 5432
      - "5432:5432"
    volumes:
      # Persist data even after container restart
      - postgres-data:/var/lib/postgresql/data
      # Init script to create multiple databases
      - ./init-scripts/init-postgres.sh:/docker-entrypoint-initdb.d/init-postgres.sh
    networks:
      - ecommerce-network
    healthcheck:
      # Check if PostgreSQL is ready to accept connections
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # MongoDB - Document database for flexible schema data
  # Used by: Product Service (Event Sourcing), Review Service, Notification Service
  mongodb:
    image: mongo:7.0
    container_name: ecommerce-mongodb
    environment:
      # Root username and password
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      # Initialize product database
      MONGO_INITDB_DATABASE: ecommerce_product_db
    ports:
      # Map MongoDB port
      - "27017:27017"
    volumes:
      # Persist MongoDB data
      - mongodb-data:/data/db
    networks:
      - ecommerce-network
    healthcheck:
      # Check if MongoDB is ready
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Redis - In-memory cache and session store
  # Used by: All services for caching and rate limiting
  redis:
    image: redis:7-alpine
    container_name: ecommerce-redis
    ports:
      # Map Redis port
      - "6379:6379"
    volumes:
      # Persist Redis data
      - redis-data:/data
    networks:
      - ecommerce-network
    healthcheck:
      # Check if Redis is responding
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # ==================== MESSAGE QUEUE ====================
  
  # Zookeeper - Required for Kafka (manages cluster metadata)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: ecommerce-zookeeper
    environment:
      # Zookeeper client port
      ZOOKEEPER_CLIENT_PORT: 2181
      # Zookeeper tick time (milliseconds)
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - ecommerce-network
  
  # Apache Kafka - Event streaming platform for asynchronous communication
  # Used by: All services for event-driven architecture
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: ecommerce-kafka
    depends_on:
      - zookeeper
    ports:
      # Kafka port for external connections
      - "9092:9092"
      # Kafka port for internal connections
      - "29092:29092"
    environment:
      # Kafka broker ID
      KAFKA_BROKER_ID: 1
      # Zookeeper connection string
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Advertised listeners (how clients connect)
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      # Listener security protocol map
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      # Inter-broker listener
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      # Offsets topic replication factor
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      # Auto-create topics when publishing
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    networks:
      - ecommerce-network
    healthcheck:
      # Check if Kafka is ready
      test: kafka-topics --bootstrap-server kafka:29092 --list
      interval: 30s
      timeout: 10s
      retries: 5
  
  # Kafka UI - Web interface for managing Kafka
  # Access at: http://localhost:8090
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: ecommerce-kafka-ui
    depends_on:
      - kafka
    ports:
      - "8090:8080"
    environment:
      # Kafka cluster configuration
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    networks:
      - ecommerce-network
  
  # ==================== OBSERVABILITY ====================
  
  # Zipkin - Distributed tracing system
  # Collects timing data for troubleshooting latency problems
  # Access at: http://localhost:9411
  zipkin:
    image: openzipkin/zipkin:latest
    container_name: ecommerce-zipkin
    ports:
      # Zipkin UI port
      - "9411:9411"
    environment:
      # Storage type (in-memory for development)
      STORAGE_TYPE: mem
    networks:
      - ecommerce-network
  
  # Prometheus - Metrics collection and monitoring
  # Scrapes metrics from all services via /actuator/prometheus
  # Access at: http://localhost:9090
  prometheus:
    image: prom/prometheus:latest
    container_name: ecommerce-prometheus
    ports:
      - "9090:9090"
    volumes:
      # Prometheus configuration file
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      # Persist Prometheus data
      - prometheus-data:/prometheus
    command:
      # Use custom config file
      - '--config.file=/etc/prometheus/prometheus.yml'
      # Enable admin API
      - '--web.enable-admin-api'
    networks:
      - ecommerce-network
  
  # Grafana - Metrics visualization and dashboards
  # Connects to Prometheus for data source
  # Access at: http://localhost:3000 (admin/admin)
  grafana:
    image: grafana/grafana:latest
    container_name: ecommerce-grafana
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    environment:
      # Default admin credentials
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      # Prometheus data source
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      # Persist Grafana data
      - grafana-data:/var/lib/grafana
      # Grafana provisioning (datasources, dashboards)
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - ecommerce-network
  
  # ==================== ELK STACK (CENTRALIZED LOGGING) ====================
  
  # Elasticsearch - Search and analytics engine for logs
  # Stores and indexes all application logs
  # Access at: http://localhost:9200
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: ecommerce-elasticsearch
    environment:
      # Single-node cluster for development
      - discovery.type=single-node
      # Disable security for development
      - xpack.security.enabled=false
      # JVM heap size (adjust based on available memory)
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      # Elasticsearch HTTP API
      - "9200:9200"
      # Elasticsearch TCP transport
      - "9300:9300"
    volumes:
      # Persist Elasticsearch data
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
  
  # Logstash - Log processing pipeline
  # Receives logs from services, processes them, and sends to Elasticsearch
  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    container_name: ecommerce-logstash
    depends_on:
      - elasticsearch
    ports:
      # Logstash input (receives logs)
      - "5000:5000"
      # Logstash TCP input
      - "5044:5044"
    volumes:
      # Logstash configuration
      - ./logstash/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    environment:
      # Elasticsearch connection
      - "LS_JAVA_OPTS=-Xms256m -Xmx256m"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9600/_node/stats || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
  
  # Kibana - Visualization platform for Elasticsearch
  # Provides UI for searching, viewing, and analyzing logs
  # Access at: http://localhost:5601
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: ecommerce-kibana
    depends_on:
      - elasticsearch
    ports:
      - "5601:5601"
    environment:
      # Elasticsearch connection
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      # Disable security for development
      XPACK_SECURITY_ENABLED: "false"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==================== MICROSERVICES ====================

  # Service Discovery (Eureka Server) - Port 8761
  # Central registry for all microservices
  # All services register here for service discovery
  eureka-server:
    build:
      context: ..
      dockerfile: infrastructure/service-discovery/Dockerfile
    container_name: ecommerce-eureka
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8761/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Config Server - Port 8888
  # Centralized configuration management for all services
  config-server:
    build:
      context: ..
      dockerfile: infrastructure/config-server/Dockerfile
    container_name: ecommerce-config-server
    depends_on:
      eureka-server:
        condition: service_healthy
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8888/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # API Gateway - Port 8080
  # Single entry point for all client requests
  # Routes requests to appropriate microservices
  api-gateway:
    build:
      context: ..
      dockerfile: infrastructure/api-gateway/Dockerfile
    container_name: ecommerce-api-gateway
    depends_on:
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Auth Service - Port 9001
  # Handles authentication, authorization, OAuth2, JWT, 2FA
  auth-service:
    build:
      context: ..
      dockerfile: services/auth-service/Dockerfile
    container_name: ecommerce-auth-service
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    ports:
      - "9001:9001"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/auth_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_ZIPKIN_BASEURL=http://zipkin:9411
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9001/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # User Service - Port 9002
  # Manages user profiles with CQRS pattern and PostgreSQL replication
  user-service:
    build:
      context: ..
      dockerfile: services/user-service/Dockerfile
    container_name: ecommerce-user-service
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    ports:
      - "9002:9002"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATASOURCE_PRIMARY_URL=jdbc:postgresql://postgres:5432/user_db
      - SPRING_DATASOURCE_PRIMARY_USERNAME=postgres
      - SPRING_DATASOURCE_PRIMARY_PASSWORD=postgres
      - SPRING_DATASOURCE_REPLICA_URL=jdbc:postgresql://postgres:5432/user_db
      - SPRING_DATASOURCE_REPLICA_USERNAME=postgres
      - SPRING_DATASOURCE_REPLICA_PASSWORD=postgres
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - SPRING_ZIPKIN_BASEURL=http://zipkin:9411
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9002/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Product Service - Port 9003
  # Manages products with Event Sourcing pattern and MongoDB
  product-service:
    build:
      context: ..
      dockerfile: services/product-service/Dockerfile
    container_name: ecommerce-product-service
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    ports:
      - "9003:9003"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATA_MONGODB_URI=mongodb://admin:admin123@mongodb:27017/ecommerce_product_db?authSource=admin
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - SPRING_ZIPKIN_BASEURL=http://zipkin:9411
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9003/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Order Service - Port 9004
  # Manages orders with Saga pattern for distributed transactions
  order-service:
    build:
      context: ..
      dockerfile: services/order-service/Dockerfile
    container_name: ecommerce-order-service
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    ports:
      - "9004:9004"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/order_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - SPRING_ZIPKIN_BASEURL=http://zipkin:9411
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9004/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Payment Service - Port 9005
  # Handles payments with Circuit Breaker and resilience patterns
  payment-service:
    build:
      context: ..
      dockerfile: services/payment-service/Dockerfile
    container_name: ecommerce-payment-service
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    ports:
      - "9005:9005"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/payment_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - SPRING_ZIPKIN_BASEURL=http://zipkin:9411
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9005/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Notification Service - Port 9006
  # Handles notifications with multithreading and WebSocket
  notification-service:
    build:
      context: ..
      dockerfile: services/notification-service/Dockerfile
    container_name: ecommerce-notification-service
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    ports:
      - "9006:9006"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATA_MONGODB_URI=mongodb://admin:admin123@mongodb:27017/ecommerce_notification_db?authSource=admin
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - SPRING_ZIPKIN_BASEURL=http://zipkin:9411
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9006/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Review Service - Port 9007
  # Manages reviews with gRPC communication
  review-service:
    build:
      context: ..
      dockerfile: services/review-service/Dockerfile
    container_name: ecommerce-review-service
    depends_on:
      mongodb:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    ports:
      - "9007:9007"
      - "50051:50051"  # gRPC port
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_DATA_MONGODB_URI=mongodb://admin:admin123@mongodb:27017/ecommerce_review_db?authSource=admin
      - SPRING_ZIPKIN_BASEURL=http://zipkin:9411
      - GRPC_SERVER_PORT=50051
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9007/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

# Define named volumes for data persistence
# Data persists even after containers are stopped/removed
volumes:
  postgres-data:
    driver: local
  mongodb-data:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  elasticsearch-data:
    driver: local

# Define custom network for inter-container communication
# All services can communicate using service names as hostnames
networks:
  ecommerce-network:
    driver: bridge
    # Enable DNS resolution between containers
    name: ecommerce-network

